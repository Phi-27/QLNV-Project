<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω nh√¢n vi√™n - Speed POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="bg-gray-100 font-sans">
    <div class="flex">
        <!-- Main content -->
        <main class="flex-1 p-6">
            <!-- Header -->
            <div class="bg-white rounded-xl shadow header">
                <div class="flex items-center justify-between px-6 py-4">
                    <img src="/images/Logo-SpeedPos.webp" alt="Speed POS" class="h-8">
                    <!-- T√¨m ki·∫øm -->
                    <input type="text" placeholder="üîç T√¨m ki·∫øm..." class="w-1/2 px-4 py-2 border rounded-full shadow-sm" id="search-input">
                    <!-- Th√¥ng tin ng∆∞·ªùi d√πng -->
                    <div class="relative group cursor-pointer">
                        <div class="flex items-center space-x-3">
                            <img src="/images/images.jpeg" alt="·∫¢nh admin" class="w-12 h-12 rounded-full object-cover" />
                            <div class="text-sm">
                                <div class="font-semibold" id="user-name">T√™n admin</div>
                                <div class="text-gray-500 text-xs" id="user-email">mail admin</div>
                            </div>
                        </div>
                        <!-- Dropdown menu -->
                        <div class="absolute right-0 mt-2 w-40 bg-white border border-gray-200 rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition duration-200 z-50">
                            <a href="/admin_page/admin.html" class="text-center block px-4 py-2 hover:bg-gray-100 text-sm">Xem h·ªì s∆°</a>
                            <a href="/admin_page/doimatkhau.html" class="text-center block px-4 py-2 hover:bg-gray-100 text-sm">ƒê·ªïi m·∫≠t kh·∫©u</a>
                            <a href="#" onclick="logout()" class="block px-4 py-2 hover:bg-gray-100 text-sm text-center">ƒêƒÉng xu·∫•t</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content with Sidebar and Employee Cards -->
            <div class="flex mt-6">
                <!-- Sidebar -->
                <aside class="w-64 bg-white rounded shadow sidebar">
                    <nav class="px-4 py-2 space-y-2">
                        <a href="/home_page/index.html" class="flex items-center space-x-2 text-gray-700 hover:text-blue-600">
                            <i class="lucide-home"></i> <span>Trang ch·ªß</span>
                        </a>
                        <a href="/staff_page/staff.html" class="flex items-center space-x-2 text-gray-700 hover:text-blue-600">
                            <i class="lucide-users"></i> <span>Nh√¢n vi√™n</span>
                        </a>
                        <a href="/building_page/building.html" class="flex items-center space-x-2 text-white bg-blue-600 py-2 rounded">
                            <i class="lucide-building"></i> <span>To√† nh√†</span>
                        </a>
                        <a href="/access_point_page/access_point.html" class="flex items-center space-x-2 text-gray-700 hover:text-blue-600">
                            <i class="lucide-map-pin"></i> <span>Access Point</span>
                        </a>
                        <a href="/access_history_page/access_history.html" class="flex items-center space-x-2 text-gray-700 hover:text-blue-600">
                            <i class="lucide-history"></i> <span>L·ªãch s·ª≠ truy c·∫≠p</span>
                        </a>
                    </nav>
                </aside>

                <!-- Employee Table -->
                <div class="flex-1">
                    <div class="bg-white rounded-lg shadow p-4">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-700" id="site-table">
                                <thead class="bg-gray-50 text-xs uppercase">
                                    <tr>
                                        <th class="px-4 py-2">M√£ c·ª≠a h√†ng</th>
                                        <th class="px-4 py-2">T√™n c·ª≠a h√†ng</th>
                                        <th class="px-4 py-2">ƒê·ªãa ch·ªâ</th>
                                        <th class="px-4 py-2">Tr·∫°ng th√°i</th>
                                        <th class="px-4 py-2">H√†nh ƒë·ªông</th>
                                    </tr>
                                </thead>
                                <tbody id="site-table-body">
                                    <!-- Data will be populated here via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Script to load and manage site data -->
    <script>
        lucide.createIcons();

        document.addEventListener("DOMContentLoaded", async () => {
            const searchInput = document.getElementById("search-input");
            const tableBody = document.getElementById("site-table-body");
            const userNameElement = document.querySelector("#user-name");
            const userEmailElement = document.querySelector("#user-email");

            // Fetch user info
            async function fetchUserInfo() {
                try {
                    const response = await fetch('http://localhost:33135/api/Auth/user', {
                        credentials: 'include',
                        signal: AbortSignal.timeout(5000) // Timeout 5 seconds
                    });
                    if (!response.ok) {
                        throw new Error("Kh√¥ng th·ªÉ x√°c th·ª±c: " + response.status);
                    }
                    const user = await response.json();
                    const role = user.role?.toString().trim();
                    if (role !== "admin") {
                        alert("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y.");
                        window.location.href = '/nhanvien_page/home.html';
                        return false;
                    }
                    userNameElement.textContent = user.name || "T√™n admin";
                    userEmailElement.textContent = user.email || "mail admin";
                    return true;
                } catch (error) {
                    console.error('Error fetching user info:', error);
                    alert('L·ªói x√°c th·ª±c: ' + error.message);
                    window.location.href = '/login_page/login.html';
                    return false;
                }
            }

            async function fetchSites() {
                try {
                    const response = await fetch('http://localhost:33135/api/Site', {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        },
                        credentials: 'include' // Include session cookies
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}, Message: ${await response.text()}`);
                    }
                    const sites = await response.json();
                    console.log("Fetched sites:", sites);
                    renderSites(sites);
                    return sites; // Return sites for filtering
                } catch (error) {
                    console.error("Fetch error details:", error);
                    alert("Kh√¥ng th·ªÉ t·∫£i danh s√°ch c·ª≠a h√†ng: " + error.message);
                    tableBody.innerHTML = '<tr><td colspan="5">Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu.</td></tr>';
                    return [];
                }
            }

            function renderSites(sites) {
                tableBody.innerHTML = '';
                if (!sites || !sites.length) {
                    tableBody.innerHTML = '<tr><td colspan="5">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>';
                    return;
                }
                sites.forEach(site => {
                    let status = "B·∫£o tr√¨";
                    let statusColor = "text-yellow-600";
                    if (site.isActive === true) {
                        status = "Ho·∫°t ƒë·ªông";
                        statusColor = "text-green-600";
                    } else if (site.isActive === false) {
                        status = "Ng·ª´ng ho·∫°t ƒë·ªông";
                        statusColor = "text-red-600";
                    }

                    const row = document.createElement("tr");
                    row.classList.add("border-b", "hover:bg-gray-100");
                    row.innerHTML = `
                                <td class="px-4 py-2">${site.siteId || 'N/A'}</td>
                                <td class="px-4 py-2">${site.siteName || 'Ch∆∞a c√≥ t√™n'}</td>
                                <td class="px-4 py-2">${site.address || 'Ch∆∞a c√≥ ƒë·ªãa ch·ªâ'}</td>
                                <td class="px-4 py-2 ${statusColor}">${status}</td>
                                <td class="px-4 py-2">
                                    <div class="flex items-center space-x-4">
                                        <a href="/building_detail_page/building_detail.html?id=${site.siteId}" class="text-blue-600 hover:underline flex items-center space-x-1">
                                            <i data-lucide="eye" class="w-4 h-4"></i>
                                            <span>Xem chi ti·∫øt</span>
                                        </a>
                                        <button class="text-red-600 hover:underline flex items-center space-x-1 delete-btn" data-id="${site.siteId}">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            <span>Xo√°</span>
                                        </button>
                                    </div>
                                </td>
                            `;
                    tableBody.appendChild(row);
                });
                lucide.createIcons(); // Reinitialize icons after adding rows
            }

            tableBody.addEventListener("click", (e) => {
                if (e.target.closest(".delete-btn")) {
                    const button = e.target.closest(".delete-btn");
                    const siteId = button.getAttribute("data-id");
                    const row = button.closest("tr");
                    const siteName = row.querySelector("td:nth-child(2)").textContent.trim();

                    if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° khu v·ª±c "${siteName}"?`)) {
                        deleteSite(siteId, row);
                    }
                }
            });

            async function deleteSite(siteId, row) {
                try {
                    const response = await fetch(`http://localhost:33135/api/Site/${siteId}`, {
                        method: "DELETE",
                        credentials: 'include' // Include session cookies
                    });
                    if (!response.ok) throw new Error(await response.text());
                    row.remove();
                    alert("X√≥a th√†nh c√¥ng!");
                } catch (error) {
                    console.error("Error deleting site:", error);
                    alert("L·ªói khi x√≥a: " + error.message);
                }
            }

            searchInput.addEventListener("input", async () => {
                const keyword = searchInput.value.toLowerCase();
                const sites = await fetchSites();
                const filteredSites = sites.filter(site =>
                    (site.siteName?.toLowerCase().includes(keyword) || false) ||
                    (site.address?.toLowerCase().includes(keyword) || false)
                );
                renderSites(filteredSites);
            });

            // Logout function
            window.logout = async () => {
                try {
                    await fetch('http://localhost:33135/api/Auth/logout', {
                        method: 'POST',
                        credentials: 'include'
                    });
                    window.location.href = '/login_page/login.html';
                } catch (error) {
                    console.error('Error logging out:', error);
                    window.location.href = '/login_page/login.html';
                }
            };

            // Initialize
            const isAuthenticated = await fetchUserInfo();
            if (isAuthenticated) {
                await fetchSites();
            }
        });
    </script>
</body>
</html>